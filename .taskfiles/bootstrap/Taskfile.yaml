# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
tasks:
  playground:
    desc: create vm and Bootstrap cluster
    vars:
      cluster: playground
      KUBERNETES_DIR: "{{.KUBERNETES_ROOT}}"
    env:
      KUBERNETES_DIR: "{{.KUBERNETES_DIR}}"
    preconditions:
      - sh: which limactl
    cmds:
      - cat {{.ROOT_DIR}}/k3s-template.yaml | limactl create --name=playground -
      - limactl start playground
      - export KUBECONFIG=~/.lima/playground/copied-from-guest/kubeconfig.yaml
      - limactl copy {{.ROOT_DIR}}/bootstrap/vm-bootstrap.sh playground:/home/lima.linux/bootstrap.sh
      - limactl shell playground -- bash /home/lima.linux/bootstrap.sh
      - task: deploy
  deploy:
    desc: set up cluster
    preconditions:
      - test -f "${KUBECONFIG}"
      - test -f {{.ROOT_DIR}}/bootstrap/bootstrap-cluster.sh
      - test -f {{.ROOT_DIR}}/bootstrap/helmfile.yaml
    env:
      KUBERNETES_DIR: "{{.KUBERNETES_DIR}}"
      # KUBECONFIG: "{{.KUBERNETES_DIR}}/kubeconfig"
    vars:
      KUBERNETES_DIR: "{{.KUBERNETES_ROOT}}"
    cmds:
      - bash {{.ROOT_DIR}}/bootstrap/bootstrap-cluster.sh
  destroy:
    desc: destory cluster and vm
    preconditions:
      - sh: which limactl
    cmds:
      - limactl stop playground -f
      - limactl delete playground
